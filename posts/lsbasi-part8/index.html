<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title> 一起来写个简单的解释器（8）</title><meta name="description" content=" 本文是Ruslan Spivak的《一起来写个简单的解释器》系列的第8篇（第7篇）。如果你对kotlin感兴趣，可以参考我的spi-kotlin。"><link rel="canonical" href="http://localhost:4000/posts/lsbasi-part8/"><link rel="alternate" type="application/rss+xml" title="yongkun" href="http://localhost:4000/feed.xml"><link href='https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|Roboto+Condensed:700&subset=latin' rel='stylesheet' type='text/css'><link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"><meta property="og:url" content="http://localhost:4000/posts/lsbasi-part8/"><meta property="og:type" content="website"><meta property="og:title" content="一起来写个简单的解释器（8）"><meta property="og:description" content="一个简单的解释器"><meta property="og:site_name" content="yongkun"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="http://localhost:4000/posts/lsbasi-part8/"><meta name="twitter:title" content="一起来写个简单的解释器（8）"><meta name="twitter:description" content="一个简单的解释器"><meta property="og:image" content="http://localhost:4000/assets/images/wallhaven-405775.jpg"><meta name="twitter:image" content="http://localhost:4000/assets/images/wallhaven-405775.jpg"> <script src="/assets/js/jquery-3.3.1.js"></script> <script src="/assets/js/barba.min.js"></script> <script src="/assets/js/imagesloaded.js"></script><body><div id="barba-wrapper"><div class="barba-container"><div id="shadow"></div><header class="main-header content-wrapper"> <input type="checkbox" id="menu-checkbox" /><nav class="center-wrapper nav-main"> <a class="blog-logo" href="/">yongkun</a> <a href="/about/">About</a> <a href="/archive/">Archive</a> <a href="/feed.xml">RSS</a> <label for="menu-checkbox" class="toggle-button" data-open="☰" data-close="☰" onclick></label></nav></header><aside class="sidebar" role="note"><div class="cover"><div class="cover-image"></div><div class="cover-image cover-image-on" style="background-image: url(http://localhost:4000/assets/images/wallhaven-405775.jpg)"></div><div class="cover-text"><div class="heading"> <a href="/posts/#translate">translate</a></div><p> 一个简单的解释器</div></div><div id="switcher"></div></aside><main class="content-wrapper"><article class="post"><h1 class="post-title">一起来写个简单的解释器（8）</h1><p class="post-meta"> <time datetime="2017-06-05">05-06-2017</time> &nbsp;/&nbsp; <span>yongkun</span><div class="post-content"><blockquote><p>本文是<a href="https://ruslanspivak.com/">Ruslan Spivak</a>的《一起来写个简单的解释器》系列的第8篇（<a href="/posts/lsbasi-part7">第7篇</a>）。<br /> 如果你对kotlin感兴趣，可以参考我的<a href="https://github.com/shiyongkun/spi-kotlin/tree/part8">spi-kotlin</a>。</blockquote><p>今天我们要学习两种一元操作符：一元加(+)和一元减(-)。<p>今天的很多内容都是以上一篇文章为基础的。如果<a href="/posts/lsbasi-part7">上一章</a>的有些内容你已经记不清了，可以先回去复习一下。记住：重复是学习之母。<p>闲话少说，今天你会学到：<ul><li>扩展语法，增加对一元加和一元减的支持<li>增加新的 <em>UnaryOp</em> AST节点类<li>扩展分析器，支持 <em>UnaryOp</em> 类型的AST节点<li>扩展翻译器，增加新的visit_UnaryOp方法来处理一元操作符</ul><p>开始吧？<p>到目前为止我们处理的都是二元操作符(+, -, *, /)，也就是操作两个操作数的操作符。那么一元操作符是什么呢？<em>一元操作符</em> 是只操作一个操作数的操作符。一元加和一元减操作符的运算规则如下：<ul><li>一元减操作符的结果是它的操作数的相反数<li>一元加操作符的结果是它的操作数自身<li>一元操作符的优先级高于二元操作符 (加减乘除）</ul><p>在表达式“+ - 3”中，第一个操作符“+”表示一元加操作，第二个操作符“-”表示一元减操作。表达式“+ - 3”等价于“+(-(3))”，也就是-3。你也可以把表达式里的-3看做一个负数，不过在这篇文章里我们把它当做一个一元减操作符和一个正数3：<p><img src="/assets/images/lsbasi-part8/lsbasi_part8_exp1.png" alt="exp1" /><p>再来看另一个表达式，“5 - - 2”：<p><img src="/assets/images/lsbasi-part8/lsbasi_part8_exp2.png" alt="exp2" /><p>在表达式“5 - - 2”里，第一个“-”表示<strong>二元</strong>减操作符，第二个“-”表示<strong>一元</strong>减操作符。<p>下面是更多的例子：<p><img src="/assets/images/lsbasi-part8/lsbasi_part8_exp3.png" alt="exp3" /><p><img src="/assets/images/lsbasi-part8/lsbasi_part8_exp4.png" alt="exp4" /><p>现在，我们要升级语法规则，来支持一元加和一元减操作符。首先先修改 <em>factor</em> 规则，在其中添加一元操作符。把一元操作符加在 factor 规则里是因为它的优先级要高于二元操作符（加减乘除）。<p>现在 <em>factor</em> 的规则从这个样子：<p><img src="/assets/images/lsbasi-part8/lsbasi_part8_factor_before.png" alt="factor_before" /><p>变成了这个样子：<p><img src="/assets/images/lsbasi-part8/lsbasi_part8_factor_after.png" alt="factor_before" /><p>可以看到，<em>factor</em> 规则引用了自己，这样 factor 就能扩展出像“- - - + - 3”这样的表达式了。<p>下面是现在的完整语法规则：<p><img src="/assets/images/lsbasi-part8/lsbasi_part8_grammar.png" alt="factor_before" /><p>下一步是增加表示一元操作符的AST节点类型：<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">UnaryOp</span><span class="p">(</span><span class="n">AST</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span></code></pre></figure><p>构造器接收两个参数：<em>op</em> 表示一元操作符的token（加或减），<em>expr</em> 表示一个AST节点。<p>升级后的语法规则中， <em>factor</em> 规则发生了变化，所以我们的分析器中的相应方法 <em>factor</em> 也需要进行修改，增加代码来处理“(PLUS | MINUS) factor”这条子规则。<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""factor : (PLUS | MINUS) factor | INTEGER | LPAREN expr RPAREN"""</span>
    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">PLUS</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">PLUS</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">UnaryOp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">MINUS</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">MINUS</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">UnaryOp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">INTEGER</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Num</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">LPAREN</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">LPAREN</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eat</span><span class="p">(</span><span class="n">RPAREN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></code></pre></figure><p>接下来扩展 <em>Interpreter</em> 类，增加 <em>visit_UnaryOp</em> 方法来翻译一元节点：<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="nb">type</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">PLUS</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">MINUS</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span></code></pre></figure><p>继续前进！<p>我们先手工构建表达式“5 - - - 2”的AST，把它传给解释器，来验证一下我们的 <em>visit_UnaryOp</em> 方法。你可以在Python shell里这样测试：<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">spi</span> <span class="kn">import</span> <span class="n">BinOp</span><span class="p">,</span> <span class="n">UnaryOp</span><span class="p">,</span> <span class="n">Num</span><span class="p">,</span> <span class="n">MINUS</span><span class="p">,</span> <span class="n">INTEGER</span><span class="p">,</span> <span class="n">Token</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">five_tok</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">two_tok</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">minus_tok</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">MINUS</span><span class="p">,</span> <span class="s">'-'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expr_node</span> <span class="o">=</span> <span class="n">BinOp</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">Num</span><span class="p">(</span><span class="n">five_tok</span><span class="p">),</span>
<span class="o">...</span>     <span class="n">minus_tok</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">UnaryOp</span><span class="p">(</span><span class="n">minus_token</span><span class="p">,</span> <span class="n">UnaryOp</span><span class="p">(</span><span class="n">minus_token</span><span class="p">,</span> <span class="n">Num</span><span class="p">(</span><span class="n">two_tok</span><span class="p">)))</span>
<span class="o">...</span> <span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">spi</span> <span class="kn">import</span> <span class="n">Interpreter</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inter</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inter</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">expr_node</span><span class="p">)</span>
<span class="mi">3</span></code></pre></figure><p>上面生成的AST树长这样： <img src="/assets/images/lsbasi-part8/lsbasi_part8_ast.png" alt="lsbasi_part8_ast" /><p>直接从<a href="https://github.com/rspivak/lsbasi/blob/master/part8/python/spi.py">GitHub</a>下载完整的解释器代码，试试更新后的解释器能不能正确求解包含一元运算符的数学表达式。<p>下面是一些测试用例：<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">python</span> <span class="n">spi</span><span class="o">.</span><span class="n">py</span>
<span class="n">spi</span><span class="o">&gt;</span> <span class="o">-</span> <span class="mi">3</span>
<span class="o">-</span><span class="mi">3</span>
<span class="n">spi</span><span class="o">&gt;</span> <span class="o">+</span> <span class="mi">3</span>
<span class="mi">3</span>
<span class="n">spi</span><span class="o">&gt;</span> <span class="mi">5</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="mi">3</span>
<span class="mi">8</span>
<span class="n">spi</span><span class="o">&gt;</span> <span class="mi">5</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">+</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="o">+</span><span class="mi">2</span>
<span class="mi">10</span></code></pre></figure><p>我也更新了<a href="https://github.com/rspivak/lsbasi/blob/master/part8/python/genastdot.py">genastdot.py</a>工具，现在它能处理一元操作符了。下面是一些生成含有一元操作符的表达式的AST图的例子：<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">python</span> <span class="n">genastdot</span><span class="o">.</span><span class="n">py</span> <span class="s">"- 3"</span> <span class="o">&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span> <span class="o">&amp;&amp;</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">o</span> <span class="n">ast</span><span class="o">.</span><span class="n">png</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span></code></pre></figure><p><img src="/assets/images/lsbasi-part8/lsbasi_part8_genastdot_01.png" alt="lsbasi_part8_genastdot_01" /><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">python</span> <span class="n">genastdot</span><span class="o">.</span><span class="n">py</span> <span class="s">"+ 3"</span> <span class="o">&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span> <span class="o">&amp;&amp;</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">o</span> <span class="n">ast</span><span class="o">.</span><span class="n">png</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span></code></pre></figure><p><img src="/assets/images/lsbasi-part8/lsbasi_part8_genastdot_02.png" alt="lsbasi_part8_genastdot_02" /><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">python</span> <span class="n">genastdot</span><span class="o">.</span><span class="n">py</span> <span class="s">"5 - - - + - 3"</span> <span class="o">&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span> <span class="o">&amp;&amp;</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">o</span> <span class="n">ast</span><span class="o">.</span><span class="n">png</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span></code></pre></figure><p><img src="/assets/images/lsbasi-part8/lsbasi_part8_genastdot_03.png" alt="lsbasi_part8_genastdot_03" /><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="n">python</span> <span class="n">genastdot</span><span class="o">.</span><span class="n">py</span> <span class="s">"5 - - - + - (3 + 4) - +2"</span> \
  <span class="o">&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span> <span class="o">&amp;&amp;</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">-</span><span class="n">o</span> <span class="n">ast</span><span class="o">.</span><span class="n">png</span> <span class="n">ast</span><span class="o">.</span><span class="n">dot</span></code></pre></figure><p><img src="/assets/images/lsbasi-part8/lsbasi_part8_genastdot_04.png" alt="lsbasi_part8_genastdot_04" /><p>给你留个小练习： <img src="/assets/images/lsbasi-part8/lsbasi_part8_exercises.png" alt="lsbasi_part8_exercises" /><ul><li>安装<a href="http://www.freepascal.org/">Free Pascal</a>，编译并运行<a href="https://github.com/rspivak/lsbasi/blob/master/part8/python/testunary.pas">testunary.pas</a>，检查结果是否与<a href="https://github.com/rspivak/lsbasi/blob/master/part8/python/spi.py">spi</a>生成的结果一致。</ul><p><br /><br /> 下面是我推荐的一些书籍列表，它们对你学习解释器和编译器有帮助：<ol><li><a href="https://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=193435645X&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=MP4DCXDV6DJMEJBL">Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)</a><li><a href="http://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0470177071&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=UCLGQTPIYSWYKRRM">Writing Compilers and Interpreters: A Software Engineering Approach</a><li><a href="http://www.amazon.com/gp/product/052182060X/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=052182060X&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=ZSKKZMV7YWR22NMW">Modern Compiler Implementation in Java</a><li><a href="http://www.amazon.com/gp/product/1461446988/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1461446988&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=PAXWJP5WCPZ7RKRD">Modern Compiler Design</a><li><a href="http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0321486811&amp;linkCode=as2&amp;tag=russblo0b-20&amp;linkId=GOEGDQG4HIHU56FQ">Compilers: Principles, Techniques, and Tools (2nd Edition)</a></ol><p>顺便，我正在写一本叫做“Let’s Build A Web Server: First Steps”的书，主要内容是关于怎么从零开始编写一个简单的web服务器。想要先睹为快的话可以点击<a href="http://ruslanspivak.com/lsbaws-part1/">这里</a>，<a href="http://ruslanspivak.com/lsbaws-part2/">这里</a>，和<a href="http://ruslanspivak.com/lsbaws-part3/">这里</a>。想知道这本书的最近更新和出版日期的话，可以到邮件列表里询问。 <a class="link-to-post" href="/posts/lsbasi-part7/"> <span class="link-to-post__prev">&#10535; &nbsp;Previous post</span> <span class="link-to-post__title">一起来写个简单的解释器（7）</span> </a></div><br/> <br/> <br/><div id="disqus_thread"></div><script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/ /* var disqus_config = function () { this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; */ (function() { var d = document, s = d.createElement('script'); s.src = 'https://shiyongkun-github-io.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></article></main><footer class="blog-footer content-wrapper"><p>&copy; <span class="full-year"></span> yongkun</footer><script src="/assets/js/scripts.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-100348669-1', 'auto'); ga('send', 'pageview'); </script></div></div>
